# Configuration de routing pour production
# Routing par domaine : monsite.com et admin.monsite.com

# Zone de rate limiting : 200 requêtes / 15 minutes par IP
# Format: 200 requêtes en 900 secondes = ~0.22 r/s, on utilise 13r/m (proche de 200/15)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=13r/m;

# Upstream pour Frontend Next.js
upstream frontend {
    server ${FRONTEND_HOST};
}

# Upstream pour Backoffice Next.js
upstream backoffice {
    server ${BACKOFFICE_HOST};
}

# Upstream pour API Gateway
upstream api_gateway {
    server ${API_GATEWAY_HOST};
}

# Server block pour monsite.com (Frontend)
server {
    listen 80;
    server_name monsite.com www.monsite.com;

    # Headers pour transmettre l'IP réelle
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Health check sans rate limiting
    location /api/health {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes pour les images uploadées (sans rate limiting)
    location /uploads/ {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes API vers API Gateway avec rate limiting
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        # Headers pour CORS et authentification
        proxy_set_header Origin $http_origin;
        proxy_set_header Cookie $http_cookie;
        # Ne pas supprimer les headers CORS de la réponse
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
    }

    # Toutes les autres routes vers Frontend Next.js
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}

# Server block pour admin.monsite.com (Backoffice)
server {
    listen 80;
    server_name admin.monsite.com;

    # Headers pour transmettre l'IP réelle
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Health check sans rate limiting
    location /api/health {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes pour les images uploadées (sans rate limiting)
    location /uploads/ {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes API vers API Gateway avec rate limiting
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        # Headers pour CORS et authentification
        proxy_set_header Origin $http_origin;
        proxy_set_header Cookie $http_cookie;
        # Ne pas supprimer les headers CORS de la réponse
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
    }

    # Toutes les autres routes vers Backoffice Next.js
    location / {
        proxy_pass http://backoffice;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}
