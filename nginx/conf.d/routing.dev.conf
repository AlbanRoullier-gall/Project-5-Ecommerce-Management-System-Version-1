# Configuration de routing pour développement local
# Utilise localhost avec différents chemins

# Note: Le rate limiting est géré par l'API Gateway (plus flexible et précis avec Redis)

# Upstream pour Frontend Next.js
upstream frontend {
    server frontend:3000;
}

# Upstream pour Backoffice Next.js
upstream backoffice {
    server backoffice:3009;
}

# Upstream pour API Gateway
upstream api_gateway {
    server api-gateway:3020;
}

# Server block pour développement local
server {
    listen 80;
    server_name localhost;

    # Headers pour transmettre l'IP réelle
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Health check sans rate limiting
    location /api/health {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes pour les images uploadées (sans rate limiting)
    location /uploads/ {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes API vers API Gateway (rate limiting désactivé en développement)
    location /api/ {
        # limit_req zone=api_limit burst=50 nodelay; # Désactivé pour le développement
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        # Headers pour CORS et authentification
        proxy_set_header Origin $http_origin;
        proxy_set_header Cookie $http_cookie;
        # Ne pas supprimer les headers CORS de la réponse
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header Access-Control-Allow-Headers;
    }

    # Assets Next.js du backoffice (doit être avant /admin)
    # Nginx enlève le préfixe /admin avant d'envoyer au backoffice
    location /admin/_next/ {
        rewrite ^/admin/_next/(.*)$ /_next/$1 break;
        proxy_pass http://backoffice;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
    
    # Routes Backoffice (chemin /admin)
    # IMPORTANT: Doit être défini AVANT location / pour être prioritaire
    # Nginx enlève le préfixe /admin avant d'envoyer au backoffice
    location /admin/ {
        rewrite ^/admin(.*)$ $1 break;
        proxy_pass http://backoffice;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        # Empêcher les redirections en boucle
        proxy_redirect off;
    }
    
    # Redirection de /admin vers /admin/ (une seule fois)
    location = /admin {
        return 301 /admin/;
    }
    
    # Redirection de /auth vers /admin/auth (authentification dans le backoffice)
    location = /auth {
        return 301 /admin/auth/login;
    }
    
    location /auth/ {
        rewrite ^/auth(.*)$ /admin/auth$1 permanent;
    }

    # Routes Frontend (chemin /)
    # Doit être défini EN DERNIER pour capturer toutes les autres routes
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}
