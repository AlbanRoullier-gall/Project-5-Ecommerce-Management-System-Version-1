# Configuration de routing pour Railway
# Utilise un seul domaine avec des chemins différents
# Pour utiliser cette config, renommez-la en routing.conf ou modifiez le Dockerfile

# Zone de rate limiting : 200 requêtes / 15 minutes par IP
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=13r/m;

# Upstream pour Frontend Next.js
upstream frontend {
    server ${FRONTEND_URL:-frontend:3000};
}

# Upstream pour Backoffice Next.js
upstream backoffice {
    server ${BACKOFFICE_URL:-backoffice:3000};
}

# Upstream pour API Gateway
upstream api_gateway {
    server ${API_GATEWAY_URL:-api-gateway:3020};
}

# Server block unique pour Railway
server {
    listen 80;
    server_name _;  # Accepte tous les domaines

    # Headers pour transmettre l'IP réelle
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Health check sans rate limiting
    location /api/health {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Routes pour les images uploadées (sans rate limiting)
    location /uploads/ {
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Assets Next.js du backoffice
    location /admin/_next/ {
        rewrite ^/admin/_next/(.*)$ /_next/$1 break;
        proxy_pass http://backoffice;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
    
    # Routes Backoffice (chemin /admin)
    location /admin/ {
        rewrite ^/admin(.*)$ $1 break;
        proxy_pass http://backoffice;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
    
    # Redirection de /admin vers /admin/
    location = /admin {
        return 301 /admin/;
    }
    
    # Redirection de /auth vers /admin/auth
    location = /auth {
        return 301 /admin/auth/login;
    }
    
    location /auth/ {
        rewrite ^/auth(.*)$ /admin/auth$1 permanent;
    }

    # Routes API vers API Gateway avec rate limiting
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass http://api_gateway;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Toutes les autres routes vers Frontend Next.js
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
}
