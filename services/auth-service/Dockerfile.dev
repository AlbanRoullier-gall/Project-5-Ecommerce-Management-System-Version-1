# ===== IMAGE DE BASE =====
FROM node:18-alpine

# ===== MÉTADONNÉES =====
LABEL maintainer="auth-service-dev"
LABEL description="Authentication Microservice - Development Mode with Auto-Migrations"
LABEL version="1.0.0-dev"

# ===== CONFIGURATION DE L'ENVIRONNEMENT =====
WORKDIR /app

# ===== INSTALLATION DES DÉPENDANCES SYSTÈME =====
# Installation des outils de développement
RUN apk add --no-cache \
    curl \
    bash \
    git

# ===== INSTALLATION DES OUTILS DE DÉVELOPPEMENT =====
# Installation globale de ts-node-dev pour le hot reloading
RUN npm install -g ts-node-dev

# ===== COPIE DES TYPES PARTAGÉS =====
# Copier les types partagés depuis la racine du projet
COPY shared-types/ ./shared-types/

# ===== GESTION DES DÉPENDANCES NODE.JS =====
# Copier les fichiers de configuration
COPY services/auth-service/package*.json ./
COPY services/auth-service/tsconfig.json ./

# Installer toutes les dépendances (dev + prod)
RUN npm ci

# ===== COPIE DU CODE SOURCE =====
# Copier le code source TypeScript
COPY services/auth-service/src/ ./src/

# ===== SÉCURITÉ =====
# Créer un utilisateur non-root pour la sécurité
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# Changer la propriété du répertoire de l'application
RUN chown -R nodejs:nodejs /app
USER nodejs

# ===== CONFIGURATION DU RÉSEAU =====
EXPOSE 3008

# ===== HEALTHCHECK POUR LE DÉVELOPPEMENT =====
# Vérification de santé du service en mode développement
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3008/api/health || exit 1

# ===== COMMANDE DE DÉMARRAGE EN DÉVELOPPEMENT =====
# Utilise ts-node-dev pour le hot reloading
# Les migrations s'exécutent automatiquement au démarrage
CMD ["npm", "run", "dev"]


