# ===== IMAGE DE BASE =====
FROM node:18-alpine

# ===== MÉTADONNÉES =====
LABEL maintainer="pdf-export-service-dev"
LABEL description="PDF Export Microservice - Development Mode"
LABEL version="1.0.0-dev"

# ===== CONFIGURATION DE L'ENVIRONNEMENT =====
WORKDIR /app

# ===== INSTALLATION DES DÉPENDANCES SYSTÈME =====
# Installation des outils de développement et dépendances pour Puppeteer
RUN apk add --no-cache \
    curl \
    bash \
    git \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# Tell Puppeteer to use the installed Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# ===== INSTALLATION DES OUTILS DE DÉVELOPPEMENT =====
# Installation globale de ts-node-dev pour le hot reloading
RUN npm install -g ts-node-dev

# ===== COPIE DES TYPES PARTAGÉS =====
# Copier les types partagés depuis la racine du projet
COPY shared-types/ ./shared-types/

# ===== GESTION DES DÉPENDANCES NODE.JS =====
# Copier les fichiers de configuration
COPY services/pdf-export-service/package*.json ./
COPY services/pdf-export-service/tsconfig.json ./

# Installer toutes les dépendances (dev + prod)
RUN npm ci

# ===== COPIE DU CODE SOURCE =====
# Copier le code source TypeScript
COPY services/pdf-export-service/src/ ./src/

# ===== SÉCURITÉ =====
# Créer un utilisateur non-root pour la sécurité
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# Changer la propriété du répertoire de l'application
RUN chown -R nodejs:nodejs /app
USER nodejs

# ===== CONFIGURATION DU RÉSEAU =====
EXPOSE 3040

# ===== HEALTHCHECK POUR LE DÉVELOPPEMENT =====
# Vérification de santé du service en mode développement
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3040/api/health || exit 1

# ===== COMMANDE DE DÉMARRAGE EN DÉVELOPPEMENT =====
# Utilise ts-node-dev pour le hot reloading
CMD ["npm", "run", "dev"]
