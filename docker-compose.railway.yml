# Docker Compose pour Railway - Production
# IMPORTANT : Railway utilise des services gérés pour PostgreSQL et Redis
# Ne déployez PAS les conteneurs customer-db, product-db, order-db, auth-db, redis

services:
  # API Gateway
  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports:
      - "3020:3020"
    environment:
      - NODE_ENV=production
      - DOCKER_ENV=true
    depends_on:
      - customer-service
      - product-service
      - order-service
      - cart-service
      - payment-service
      - email-service
      - auth-service
      - pdf-export-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Customer Service
  customer-service:
    build:
      context: .
      dockerfile: services/customer-service/Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
    depends_on:
      - auth-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Product Service
  product-service:
    build:
      context: .
      dockerfile: services/product-service/Dockerfile
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - DOCKER_ENV=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Order Service
  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
    depends_on:
      - customer-service
      - product-service
      - payment-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Cart Service
  cart-service:
    build:
      context: .
      dockerfile: services/cart-service/Dockerfile
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Payment Service
  payment-service:
    build:
      context: .
      dockerfile: services/payment-service/Dockerfile
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3007/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Email Service
  email-service:
    build:
      context: .
      dockerfile: services/email-service/Dockerfile
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3008/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PDF Export Service
  pdf-export-service:
    build:
      context: .
      dockerfile: services/pdf-export-service/Dockerfile
    ports:
      - "3040:3040"
    environment:
      - NODE_ENV=production
      - PORT=3040
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3040/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - api-gateway

  # Backoffice
  backoffice:
    build:
      context: .
      dockerfile: backoffice/Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - api-gateway
# NOTE: PostgreSQL et Redis sont gérés par Railway comme services séparés
# Ne les incluez PAS dans ce docker-compose.yml
# Utilisez les variables d'environnement Railway pour les connexions :
# - ${{Postgres.DATABASE_URL}}/nom_database
# - ${{Redis.REDIS_URL}}
